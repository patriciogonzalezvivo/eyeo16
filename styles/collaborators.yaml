# author: Patricio Gonzalez Vivo (@patriciogv) - 2016 
# 
#   Collaborators of The Book of shaders by may 2016
#

import:
    - https://tangrams.github.io/blocks/global.yaml
    - https://tangrams.github.io/blocks/patterns/grid.yaml
    - https://tangrams.github.io/blocks/lines/dash.yaml
    - https://tangrams.github.io/blocks/points/cross.yaml
    - https://tangrams.github.io/blocks/elevation/stripes.yaml
    - https://tangrams.github.io/blocks/points/shape.yaml

sources:
    osm:
        type: TopoJSON
        url:  https://vector.mapzen.com/osm/all/{z}/{x}/{y}.topojson?api_key=vector-tiles-Nhm6Mkg
        rasters: [normals-elevation]
    normals-elevation:
        type: Raster
        url: https://s3.amazonaws.com/elevation-tiles-prod/normal/{z}/{x}/{y}.png
        max_zoom: 15
    collab: 
        type: GeoJSON
        url: https://patriciogonzalezvivo.github.io/eyeo16/data/collaborators.json

textures:
    collab:
        url: https://patriciogonzalezvivo.github.io/eyeo16/data/collaborators.png
scene:
    background:
        color: white

cameras:
    perspective:
        type: perspective
        
lights:
    dir:
        type: directional
        direction: [0.489,0.786,-0.379]
        diffuse: .9
        ambient: .5
        
layers:
    water:
        data: { source: osm }
        draw:
            water:
                order: global.order
                color: white
    earth:
        data: { source: osm }
        draw:
            earth:
                order: global.order
                color: white
            lines:
                order: global.order-top
                color: black
                width: 2px
    landuse:
        data: { source: osm }
        draw:
            landuse:
                order: global.order
                color: white
    roads:
        data: { source: osm }
        filter: { not: { kind: [rail, ferry] } }
        draw:
            roads:
                order: global.order
                color: [0.988, 0.988, 0.988]
                width: [[7,0.0px], [10, .5px], [15, .75px], [17, 5m]]
        highway:
            filter: { kind: highway }
            draw:
                roads:
                    order: global.order
                    width: [[8,0px], [8,.25px], [11, 1.5px], [14, 2px], [16, 4px], [17, 10m]]
            link:
                filter: { is_link: yes } # on- and off-ramps, etc
                draw:
                    roads:
                        width: [[8,0px], [14, 3px], [16, 5px], [18, 10m]]
                tunnel-link:
                    filter: {is_tunnel: yes, $zoom: {min: 13} }
        tunnel:
            filter: {is_tunnel: yes }
            draw:
                roads:
                    order: global.order
    boundaries:
        data: { source: osm }
        draw:
            lines-dash:
                order: global.order
                color: white
                width: 1px

    collaborators:
        data: { source: collab }
        draw:
            points-shape:
                color: black
                size: 30px
                collide: false
            text:
                offset: [0, -40px]
                font:
                    transform: uppercase
                    typeface: Helvetica
                    fill: black
                    size: 15px
                    stroke: { color: white, width: 6 }

styles:
    water:
        base: polygons
        mix: [patterns-grid]
        lighting: false
        shaders:
            blocks:
                color: |
                    color.rgb -= tileGrid()*.2;
    
    earth:
        base: polygons
        raster: custom
        shaders:
            blocks:
                blocks:
                normal: |
                    vec4 raster = sampleRaster(0);
                    normal = (raster.rgb-.5)*2.;
                color: |
                    color.rgb = vec3(.5+(1.-raster.a)*.5);

        
    landuse:
        base: polygons
        mix: [elevation-stripes]
                    
    roads:
        base: lines
        lighting: false
    lines-dash:
        shaders:
            defines:
                DASH_SIZE: .5
                DASH_SCALE: .3
    points-cross:
        shaders:
            defines:
                CROSS_ALPHA: .75
    points-shape:
        shaders:
            defines:
                SHAPE_SIDES: 3
                SHAPE_SIZE: 1.
                BORDER_WIDTH: 0.15

