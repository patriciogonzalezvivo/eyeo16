author: Patricio Gonzalez Vivo (@patriciogv) - 2016 

import:
    - default.yaml
    - https://tangrams.github.io/blocks/geometry/projections.yaml
    - https://tangrams.github.io/blocks/color/tools.yaml
    - https://tangrams.github.io/blocks/points/shape.yaml

sources:
    marks: 
        type: GeoJSON
        url: ../data/puyehue.json

textures:
    puyehue:
        url: https://dl.dropboxusercontent.com/u/335522/openframe/20110613.jpg

layers:
    marks:
        data: { source: marks }
        draw:
            points-shape:
                color: white
                size: 30px
                collide: false
            text:
                offset: [0, -25px]
                font:
                    transform: uppercase
                    typeface: Helvetica
                    fill: white
                    size: 15px
                    stroke: { color: black, width: 5 }

styles:        
    picture:
        base: polygons
        raster: normal
        mix: [geometry-projections, color-tools]
        shaders:
            uniforms:
                u_tex: puyehue
            blocks:
                color: |
                    vec2 pos = u_map_position.xy+v_position.xy;
                    vec2 latlon = vec2(y2lat_m(pos.y),x2lon_m(pos.x)); // 90/180
                    vec2 uv = (latlon.yx/vec2(180.,90.)+1.)*.5;
                    uv.x += -294.096*0.001;
                    uv.y += -266.584*0.001;
                    uv *= 17.088;
                    uv.x *= 9.840*0.1;
                    
                    if (uv.x < 1. && uv.x >= 0. && 
                        uv.y <= 1. && uv.y >= 0.) {
                        vec4 img = texture2D(u_tex, uv);
                        float b = getBrightness(img*7.040);
                        color = mix(color, img, pow(b,.2));
                    }
    water:
        base: polygons
        mix: [patterns-grid, picture]
        shaders:
            blocks:
                color: |
                    color += tileGrid()*.2;
    earth:
        base: polygons
        mix: [elevation-ramp, picture]

    points-shape:
        shaders:
            defines:
                SHAPE_SIDES: 3
                SHAPE_SIZE: 1.
                SHAPE_BORDER_WIDTH: 0.15
                SHAPE_BORDER_COLOR: vec3(0.1)